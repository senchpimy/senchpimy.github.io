<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Osciloscopio</title><link rel=stylesheet href=/css/style.css type=text/css media=all></head><body><main class=content><h1>Osciloscopio</h1><div class=contenidos><a href=/entradas/>Entradas</a>
<a href=/archivos/>Archivos</a>
<a href=/wallpapers/>Wallpaper</a>
<a href=/problemas>Problemas</a></div><p>Este es un proyecto que vi en internet, un arduino siendo usado como un osciloscopio, usando una pantalla oled de 64x128, <a href=http://radiopench.blog96.fc2.com/blog-entry-893.html>en este enlace esta el blog</a> y el video del que me guie fue el siguiente:</p><p>Y si accedemos a el vlog en donde se subio podemos ver el diagrama:</p><p><img src=oscilo_diagrama.png alt></p><p>Pero a mi no me funcino ese diagrama tal cual, le tuve que hacer una serie de modificaciones, primero desconecte la entrada marcada como <strong>SIG-IN</strong> de la tierra, asi como no utilice ningun capacitor aunque el diagrama tenga 3, y finalmente descarte el uso del led, por lo que finalmente el diagrama quedo de la siguiente forma para mi</p><p><img src=oscilo_diagrama_fixed.png alt></p><p>Y finalmente el codigo fue el mismo que el que se presenta en la pagina, pero por problemas del encoding no se puede que los comentarios no se vean de fomra correcta</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ino data-lang=ino><span style=display:flex><span> <span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span>
</span></span><span style=display:flex><span> <span style=color:#960050;background-color:#1e0010>簡易オシロ</span> (_20190212_OLEDoscilloscope.ino)
</span></span><span style=display:flex><span> <span style=color:#960050;background-color:#1e0010>設定スイッチ機能立ち上げ中</span> <span style=color:#ae81ff>1285</span><span style=color:#66d9ef>byte</span> ram free
</span></span><span style=display:flex><span> <span style=color:#ae81ff>2019</span><span style=color:#f92672>/</span><span style=color:#ae81ff>02</span><span style=color:#f92672>/</span><span style=color:#ae81ff>12</span><span style=color:#960050;background-color:#1e0010>版</span> <span style=color:#960050;background-color:#1e0010>ラジオペンチ</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&amp;ltWire.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&amp;ltAdafruit_GFX.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&amp;ltAdafruit_SSD1306.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&amp;ltavr/pgmspace.h&gt; // PROGMEMを使うために使用（たぶんインクルード不要）</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&amp;ltEEPROM.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SCREEN_WIDTH 128 </span><span style=color:#75715e>// OLED display width
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define SCREEN_HEIGHT 64 </span><span style=color:#75715e>// OLED display height
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define REC_LENGTH 200 </span><span style=color:#75715e>// 波形データのバッファサイズ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Declaration for an SSD1306 display connected to I2C (SDA, SCL pins)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define OLED_RESET -1 </span><span style=color:#75715e>// Reset pin # (or -1 if sharing Arduino reset pin)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Adafruit_SSD1306 <span style=color:#a6e22e>display</span>(SCREEN_WIDTH, SCREEN_HEIGHT, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Wire</span>, OLED_RESET);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//　レンジの表示名をフラッシュメモリに保存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> vRangeName[<span style=color:#ae81ff>10</span>][<span style=color:#ae81ff>5</span>] <span style=color:#66d9ef>PROGMEM</span> <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;A50V&#34;</span>, <span style=color:#e6db74>&#34;A 5V&#34;</span>, <span style=color:#e6db74>&#34; 50V&#34;</span>, <span style=color:#e6db74>&#34; 20V&#34;</span>, <span style=color:#e6db74>&#34; 10V&#34;</span>, <span style=color:#e6db74>&#34; 5V&#34;</span>, <span style=color:#e6db74>&#34; 2V&#34;</span>, <span style=color:#e6db74>&#34; 1V&#34;</span>, <span style=color:#e6db74>&#34;0.5V&#34;</span>, <span style=color:#e6db74>&#34;0.2V&#34;</span>}; <span style=color:#75715e>// 縦軸表示文字（\0含んだ文字数が必要）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span> vstring_table[] <span style=color:#66d9ef>PROGMEM</span> <span style=color:#f92672>=</span> {vRangeName[<span style=color:#ae81ff>0</span>], vRangeName[<span style=color:#ae81ff>1</span>], vRangeName[<span style=color:#ae81ff>2</span>], vRangeName[<span style=color:#ae81ff>3</span>], vRangeName[<span style=color:#ae81ff>4</span>], vRangeName[<span style=color:#ae81ff>5</span>], vRangeName[<span style=color:#ae81ff>6</span>], vRangeName[<span style=color:#ae81ff>7</span>], vRangeName[<span style=color:#ae81ff>8</span>], vRangeName[<span style=color:#ae81ff>9</span>]};
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> hRangeName[<span style=color:#ae81ff>8</span>][<span style=color:#ae81ff>6</span>] <span style=color:#66d9ef>PROGMEM</span> <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34; 50ms&#34;</span>, <span style=color:#e6db74>&#34; 20ms&#34;</span>, <span style=color:#e6db74>&#34; 10ms&#34;</span>, <span style=color:#e6db74>&#34; 5ms&#34;</span>, <span style=color:#e6db74>&#34; 2ms&#34;</span>, <span style=color:#e6db74>&#34; 1ms&#34;</span>, <span style=color:#e6db74>&#34;500us&#34;</span>, <span style=color:#e6db74>&#34;200us&#34;</span>}; <span style=color:#75715e>// 横軸(48バイト）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span> hstring_table[] <span style=color:#66d9ef>PROGMEM</span> <span style=color:#f92672>=</span> {hRangeName[<span style=color:#ae81ff>0</span>], hRangeName[<span style=color:#ae81ff>1</span>], hRangeName[<span style=color:#ae81ff>2</span>], hRangeName[<span style=color:#ae81ff>3</span>], hRangeName[<span style=color:#ae81ff>4</span>], hRangeName[<span style=color:#ae81ff>5</span>], hRangeName[<span style=color:#ae81ff>6</span>], hRangeName[<span style=color:#ae81ff>7</span>]};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> waveBuff[REC_LENGTH]; <span style=color:#75715e>// 波形データー記録メモリ (RAMがギリギリ)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>char</span> chrBuff[<span style=color:#ae81ff>10</span>]; <span style=color:#75715e>// 表示フォーマットバッファ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>String</span> hScale <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;xxxAs&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>String</span> vScale <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;xxxx&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>float</span> lsb5V <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.0055549</span>; <span style=color:#75715e>// 5Vレンジの感度係数　標準値：0.005371 V/1LSBで定義
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>float</span> lsb50V <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.051513</span>; <span style=color:#75715e>// 50Vレンジの感度係数 0.05371
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> vRange; <span style=color:#75715e>// 垂直レンジ 0:A50V, 1:A 5V, 2:50V, 3:20V, 4:10V, 5:5V, 6:2V, 7:1V, 8:0.5V
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> hRange; <span style=color:#75715e>// 水平レンジ　0:50m, 1:20m, 2:10m, 3:5m, 4;2m, 5:1m, 6:500u, 7;200u
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> trigD; <span style=color:#75715e>// トリガ方向（極性）0:ポジ、1:ネガ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> scopeP; <span style=color:#75715e>// 操作スコープ位置 0:垂直レンジ, 1:水平レンジ, 2:トリガ方向
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> hold <span style=color:#f92672>=</span> false; <span style=color:#75715e>// ホールド
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>boolean</span> paraChanged <span style=color:#f92672>=</span> false; <span style=color:#75715e>// 割込みでパラメーターが変更された時に true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> saveTimer; <span style=color:#75715e>// EEPROM保存までの残り時間
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> timeExec; <span style=color:#75715e>// 現在のレンジの概算実行時間(ms)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> dataMin; <span style=color:#75715e>// バッファの最小値(min:0)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> dataMax; <span style=color:#75715e>// バッファの最大値(max:1023)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> dataAve; <span style=color:#75715e>// バッファの平均値（精度確保のため10倍で保存 max:10230)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> rangeMax; <span style=color:#75715e>// グラフをフルスケールにするバッファの値
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> rangeMin; <span style=color:#75715e>// グラフを下限にするバッファの値
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> rangeMaxDisp; <span style=color:#75715e>// max表示の値（100倍で指定）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> rangeMinDisp; <span style=color:#75715e>// min表示の値
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> trigP; <span style=color:#75715e>// データバッファ上のトリガ位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>boolean</span> trigSync; <span style=color:#75715e>// トリガ検出フラグ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> att10x; <span style=color:#75715e>// 入力アッテネーター（1で有効）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>pinMode</span>(<span style=color:#ae81ff>2</span>, <span style=color:#66d9ef>INPUT_PULLUP</span>); <span style=color:#75715e>// ボタン入力割込み(int0割込み）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>pinMode</span>(<span style=color:#ae81ff>8</span>, <span style=color:#66d9ef>INPUT_PULLUP</span>); <span style=color:#75715e>// Selectボタン
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>pinMode</span>(<span style=color:#ae81ff>9</span>, <span style=color:#66d9ef>INPUT_PULLUP</span>); <span style=color:#75715e>// Upボタン
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>pinMode</span>(<span style=color:#ae81ff>10</span>, <span style=color:#66d9ef>INPUT_PULLUP</span>); <span style=color:#75715e>// Downボタン
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>pinMode</span>(<span style=color:#ae81ff>11</span>, <span style=color:#66d9ef>INPUT_PULLUP</span>); <span style=color:#75715e>// Hold スイッチ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>pinMode</span>(<span style=color:#ae81ff>12</span>, <span style=color:#66d9ef>INPUT</span>); <span style=color:#75715e>// アッテネーター1/10
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>pinMode</span>(<span style=color:#ae81ff>13</span>, <span style=color:#66d9ef>OUTPUT</span>); <span style=color:#75715e>// 状態表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// Serial.begin(115200); // これを使うとRAMを大量に消費する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>begin</span>(SSD1306_SWITCHCAPVCC, <span style=color:#ae81ff>0x3C</span>)) { <span style=color:#75715e>// Address 0x3C for 128x64
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#75715e>// Serial.println(F(&#34;SSD1306 failed&#34;));
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (;;); <span style=color:#75715e>// Don&#39;t proceed, loop forever
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> loadEEPROM(); <span style=color:#75715e>// EEPROMから前回の設定内容を読み出し
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>analogReference</span>(<span style=color:#66d9ef>INTERNAL</span>); <span style=color:#75715e>// ADCのフルスケール1.1Vに設定（内部vrefを使用)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>attachInterrupt</span>(<span style=color:#ae81ff>0</span>, pin2IRQ, <span style=color:#66d9ef>FALLING</span>); <span style=color:#75715e>// スイッチ操作検出時に割込み発生
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> startScreen(); <span style=color:#75715e>// 共通部分を描画
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loop</span>() {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>digitalWrite</span>(<span style=color:#ae81ff>13</span>, <span style=color:#66d9ef>HIGH</span>);
</span></span><span style=display:flex><span> setConditions(); <span style=color:#75715e>// 測定パラメーターのセット←これ使うとRAMが40バイト減る
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> readWave(); <span style=color:#75715e>// 波形読み取り (最小1.6ms )
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>digitalWrite</span>(<span style=color:#ae81ff>13</span>, <span style=color:#66d9ef>LOW</span>); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dataAnalize(); <span style=color:#75715e>// データーの各種情報を収集(0.4-0.7ms)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> writeCommonImage(); <span style=color:#75715e>// 固定イメージの描画(4.6ms)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> plotData(); <span style=color:#75715e>// グラフプロット(5.4ms+α)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dispInf(); <span style=color:#75715e>// 各種情報表示(6.2ms)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>display</span>(); <span style=color:#75715e>// バッファを転送して表示(37ms)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> saveEEPROM(); <span style=color:#75715e>// 必要があればEEPROMに設定内容を保存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>while</span> (hold <span style=color:#f92672>==</span> true) { <span style=color:#75715e>// Holdボタンが押されていたら待つ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dispHold();
</span></span><span style=display:flex><span> <span style=color:#a6e22e>delay</span>(<span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setConditions</span>() { <span style=color:#75715e>// 測定条件設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#75715e>// 横軸のレンジをPROGMEMから持ってくる
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> strcpy_P(chrBuff, (<span style=color:#66d9ef>char</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span>)pgm_read_word(<span style=color:#f92672>&amp;</span>(hstring_table[hRange]))); <span style=color:#75715e>// 横軸レンジ名を
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> hScale <span style=color:#f92672>=</span> chrBuff; <span style=color:#75715e>// hScaleに設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 縦軸レンジ設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> strcpy_P(chrBuff, (<span style=color:#66d9ef>char</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span>)pgm_read_word(<span style=color:#f92672>&amp;</span>(vstring_table[vRange]))); <span style=color:#75715e>// 縦軸レンジ名を
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> vScale <span style=color:#f92672>=</span> chrBuff; <span style=color:#75715e>// vScaleに設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>switch</span> (vRange) { <span style=color:#75715e>// 縦軸のレンジごとの設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// Auto50Vレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// rangeMax = 1023;
</span></span></span><span style=display:flex><span><span style=color:#75715e>// rangeMin = 0;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> att10x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// 入力アッテネーター使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// Auto 5Vレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// rangeMax = 1023;
</span></span></span><span style=display:flex><span><span style=color:#75715e>// rangeMin = 0;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> att10x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 入力アッテネーターを使わない
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 50Vレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span> <span style=color:#f92672>/</span> lsb50V; <span style=color:#75715e>// フルスケール画素数の設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMaxDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>5000</span>; <span style=color:#75715e>// 縦軸目盛り。100倍の値で設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMin <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> rangeMinDisp <span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> att10x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// 入力アッテネーター使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 20Vレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span> <span style=color:#f92672>/</span> lsb50V; <span style=color:#75715e>// フルスケール画素数の設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMaxDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>2000</span>;
</span></span><span style=display:flex><span> rangeMin <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> rangeMinDisp <span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> att10x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// 入力アッテネーター使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 10Vレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> <span style=color:#f92672>/</span> lsb50V; <span style=color:#75715e>// フルスケール画素数の設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMaxDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000</span>;
</span></span><span style=display:flex><span> rangeMin <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> rangeMinDisp <span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> att10x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// 入力アッテネーター使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>5</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 5Vレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>/</span> lsb5V; <span style=color:#75715e>// フルスケール画素数の設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMaxDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>;
</span></span><span style=display:flex><span> rangeMin <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> rangeMinDisp <span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> att10x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 入力アッテネーターを使わない
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>6</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 2Vレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>/</span> lsb5V; <span style=color:#75715e>// フルスケール画素数の設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMaxDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>;
</span></span><span style=display:flex><span> rangeMin <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> rangeMinDisp <span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> att10x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 入力アッテネーターを使わない
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>7</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 1Vレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>/</span> lsb5V; <span style=color:#75715e>// フルスケール画素数の設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMaxDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span> rangeMin <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> rangeMinDisp <span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> att10x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 入力アッテネーターを使わない
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>8</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 0.5Vレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span> <span style=color:#f92672>/</span> lsb5V; <span style=color:#75715e>// フルスケール画素数の設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMaxDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>;
</span></span><span style=display:flex><span> rangeMin <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> rangeMinDisp <span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> att10x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 入力アッテネーターを使わない
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>9</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 0.5Vレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.2</span> <span style=color:#f92672>/</span> lsb5V; <span style=color:#75715e>// フルスケール画素数の設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMaxDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span> rangeMin <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> rangeMinDisp <span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> att10x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 入力アッテネーターを使わない
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeCommonImage</span>() { <span style=color:#75715e>// 共通画面の作画
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.clearDisplay(); <span style=color:#75715e>// 画面全消去(0.4ms)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.setTextColor(WHITE); <span style=color:#75715e>// 白文字で描く
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>86</span>, <span style=color:#ae81ff>0</span>); <span style=color:#75715e>// Start at top-left corner
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>println</span>(F(<span style=color:#e6db74>&#34;av V&#34;</span>)); <span style=color:#75715e>// 1行目固定文字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastVLine(<span style=color:#ae81ff>26</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>55</span>, WHITE); <span style=color:#75715e>// 左縦線
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastVLine(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>55</span>, WHITE); <span style=color:#75715e>// 左縦線
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>7</span>, WHITE); <span style=color:#75715e>// Max値の補助マーク
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>36</span>, <span style=color:#ae81ff>2</span>, WHITE); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>7</span>, WHITE); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>3</span>, WHITE); <span style=color:#75715e>// Max値の補助マーク
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>3</span>, WHITE); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>76</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>3</span>, WHITE); <span style=color:#75715e>// Max値の補助マーク
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>76</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>3</span>, WHITE); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>101</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>3</span>, WHITE); <span style=color:#75715e>// Max値の補助マーク
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>101</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>3</span>, WHITE); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>123</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>5</span>, WHITE); <span style=color:#75715e>// 右端Max値の補助マーク
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>123</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>5</span>, WHITE); <span style=color:#75715e>// 　
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> x <span style=color:#f92672>=</span> <span style=color:#ae81ff>26</span>; x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>128</span>; x <span style=color:#f92672>+=</span> <span style=color:#ae81ff>5</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.drawFastHLine(x, <span style=color:#ae81ff>36</span>, <span style=color:#ae81ff>2</span>, WHITE); <span style=color:#75715e>// 中心線(水平線)を点線で描く
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> x <span style=color:#f92672>=</span> (<span style=color:#ae81ff>127</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>25</span>); x <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>30</span>; x <span style=color:#f92672>-=</span> <span style=color:#ae81ff>25</span>) {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> y <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>; y <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>63</span>; y <span style=color:#f92672>+=</span> <span style=color:#ae81ff>5</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.drawFastVLine(x, y, <span style=color:#ae81ff>2</span>, WHITE); <span style=color:#75715e>// 縦線を点線で3本描く
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>readWave</span>() { <span style=color:#75715e>// 波形をメモリーに記録
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (att10x <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) { <span style=color:#75715e>// もし1/10アッテネーターが必要なら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>pinMode</span>(<span style=color:#ae81ff>12</span>, <span style=color:#66d9ef>OUTPUT</span>); <span style=color:#75715e>// アッテネーター制御ピンを出力にして
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>digitalWrite</span>(<span style=color:#ae81ff>12</span>, <span style=color:#66d9ef>LOW</span>); <span style=color:#75715e>// LOWを出力
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> } <span style=color:#66d9ef>else</span> { <span style=color:#75715e>// アッテネーター不使用なら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>pinMode</span>(<span style=color:#ae81ff>12</span>, <span style=color:#66d9ef>INPUT</span>); <span style=color:#75715e>// アッテネーター制御ピンをHi-zにする（入力にする）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>switch</span> (hRange) { <span style=color:#75715e>// レンジに応じ記録速度を変更
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 50msレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> timeExec <span style=color:#f92672>=</span> <span style=color:#ae81ff>400</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span>; <span style=color:#75715e>// 概算実行時間(ms) EEPROM保存までのカウントダウンに使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xf8</span>; <span style=color:#75715e>// 下3ビットをクリア
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>|</span> <span style=color:#ae81ff>0x07</span>; <span style=color:#75715e>// 分周比128 (arduinoのオリジナル）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> REC_LENGTH; i<span style=color:#f92672>++</span>) { <span style=color:#75715e>// 200データー
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> waveBuff[i] <span style=color:#f92672>=</span> <span style=color:#a6e22e>analogRead</span>(<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 約112μs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>delayMicroseconds</span>(<span style=color:#ae81ff>1888</span>); <span style=color:#75715e>// サンプリング周期調整
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 20msレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> timeExec <span style=color:#f92672>=</span> <span style=color:#ae81ff>160</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span>; <span style=color:#75715e>// 概算実行時間(ms) EEPROM保存までのカウントダウンに使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xf8</span>; <span style=color:#75715e>// 下3ビットをクリア
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>|</span> <span style=color:#ae81ff>0x07</span>; <span style=color:#75715e>// 分周比128 (arduinoのオリジナル）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> REC_LENGTH; i<span style=color:#f92672>++</span>) { <span style=color:#75715e>// 200データー
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> waveBuff[i] <span style=color:#f92672>=</span> <span style=color:#a6e22e>analogRead</span>(<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 約112μs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>delayMicroseconds</span>(<span style=color:#ae81ff>688</span>); <span style=color:#75715e>// サンプリング周期調整
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 10 msレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> timeExec <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span>; <span style=color:#75715e>// 概算実行時間(ms) EEPROM保存までのカウントダウンに使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xf8</span>; <span style=color:#75715e>// 下3ビットをクリア
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>|</span> <span style=color:#ae81ff>0x07</span>; <span style=color:#75715e>// 分周比128 (arduinoのオリジナル）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> REC_LENGTH; i<span style=color:#f92672>++</span>) { <span style=color:#75715e>// 200データー
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> waveBuff[i] <span style=color:#f92672>=</span> <span style=color:#a6e22e>analogRead</span>(<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 約112μs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>delayMicroseconds</span>(<span style=color:#ae81ff>288</span>); <span style=color:#75715e>// サンプリング周期調整
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 5 msレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> timeExec <span style=color:#f92672>=</span> <span style=color:#ae81ff>40</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span>; <span style=color:#75715e>// 概算実行時間(ms) EEPROM保存までのカウントダウンに使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xf8</span>; <span style=color:#75715e>// 下3ビットをクリア
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>|</span> <span style=color:#ae81ff>0x07</span>; <span style=color:#75715e>// 分周比128 (arduinoのオリジナル）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> REC_LENGTH; i<span style=color:#f92672>++</span>) { <span style=color:#75715e>// 200データー
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> waveBuff[i] <span style=color:#f92672>=</span> <span style=color:#a6e22e>analogRead</span>(<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 約112μs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>delayMicroseconds</span>(<span style=color:#ae81ff>88</span>); <span style=color:#75715e>// サンプリング周期調整
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 2 msレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> timeExec <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span>; <span style=color:#75715e>// 概算実行時間(ms) EEPROM保存までのカウントダウンに使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xf8</span>; <span style=color:#75715e>// 下3ビットをクリア
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>|</span> <span style=color:#ae81ff>0x06</span>; <span style=color:#75715e>// 分周比64 (0x1=2, 0x2=4, 0x3=8, 0x4=16, 0x5=32, 0x6=64, 0x7=128)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> REC_LENGTH; i<span style=color:#f92672>++</span>) { <span style=color:#75715e>// 200データー
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> waveBuff[i] <span style=color:#f92672>=</span> <span style=color:#a6e22e>analogRead</span>(<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 約56μs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>delayMicroseconds</span>(<span style=color:#ae81ff>24</span>); <span style=color:#75715e>// サンプリング周期調整
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>5</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 1 msレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> timeExec <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span>; <span style=color:#75715e>// 概算実行時間(ms) EEPROM保存までのカウントダウンに使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xf8</span>; <span style=color:#75715e>// 下3ビットをクリア
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>|</span> <span style=color:#ae81ff>0x05</span>; <span style=color:#75715e>// 分周比16 (0x1=2, 0x2=4, 0x3=8, 0x4=16, 0x5=32, 0x6=64, 0x7=128)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> REC_LENGTH; i<span style=color:#f92672>++</span>) { <span style=color:#75715e>// 200データー
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> waveBuff[i] <span style=color:#f92672>=</span> <span style=color:#a6e22e>analogRead</span>(<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 約28μs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>delayMicroseconds</span>(<span style=color:#ae81ff>12</span>); <span style=color:#75715e>// サンプリング周期調整
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>6</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 500usレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> timeExec <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span>; <span style=color:#75715e>// 概算実行時間(ms) EEPROM保存までのカウントダウンに使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xf8</span>; <span style=color:#75715e>// 下3ビットをクリア
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>|</span> <span style=color:#ae81ff>0x04</span>; <span style=color:#75715e>// 分周比16(0x1=2, 0x2=4, 0x3=8, 0x4=16, 0x5=32, 0x6=64, 0x7=128)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> REC_LENGTH; i<span style=color:#f92672>++</span>) { <span style=color:#75715e>// 200データー
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> waveBuff[i] <span style=color:#f92672>=</span> <span style=color:#a6e22e>analogRead</span>(<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 約16μs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>delayMicroseconds</span>(<span style=color:#ae81ff>4</span>); <span style=color:#75715e>// サンプリング周期調整
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#75715e>// 時間微調整　1.875μs（nop 1つで1クロック、0.0625μs @16MHz)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>);
</span></span><span style=display:flex><span> <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>);
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>7</span><span style=color:#f92672>:</span> { <span style=color:#75715e>// 200usレンジ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> timeExec <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span>; <span style=color:#75715e>// 概算実行時間(ms) EEPROM保存までのカウントダウンに使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xf8</span>; <span style=color:#75715e>// 下3ビットをクリア
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ADCSRA <span style=color:#f92672>=</span> ADCSRA <span style=color:#f92672>|</span> <span style=color:#ae81ff>0x02</span>; <span style=color:#75715e>// 分周比:4(0x1=2, 0x2=4, 0x3=8, 0x4=16, 0x5=32, 0x6=64, 0x7=128)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> REC_LENGTH; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span> waveBuff[i] <span style=color:#f92672>=</span> <span style=color:#a6e22e>analogRead</span>(<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 約6μs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#75715e>// 時間微調整　1.875μs（nop 1つで1クロック、0.0625μs @16MHz)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>);
</span></span><span style=display:flex><span> <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>);
</span></span><span style=display:flex><span> <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>); <span style=color:#66d9ef>asm</span>(<span style=color:#e6db74>&#34;nop&#34;</span>);
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dataAnalize</span>() { <span style=color:#75715e>// 作図のための各種情報を設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>int</span> d;
</span></span><span style=display:flex><span> <span style=color:#66d9ef>long</span> sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 最大最小値を求める
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dataMin <span style=color:#f92672>=</span> <span style=color:#ae81ff>1023</span>; <span style=color:#75715e>// 最小
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dataMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 最大値記録変数を初期化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> REC_LENGTH; i<span style=color:#f92672>++</span>) { <span style=color:#75715e>// 最大と最小値を求める
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> d <span style=color:#f92672>=</span> waveBuff[i];
</span></span><span style=display:flex><span> sum <span style=color:#f92672>=</span> sum <span style=color:#f92672>+</span> d;
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (d <span style=color:#f92672>&lt;</span> dataMin) { <span style=color:#75715e>// 最小と
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dataMin <span style=color:#f92672>=</span> d;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (d <span style=color:#f92672>&gt;</span> dataMax) { <span style=color:#75715e>// 最大値を求める
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dataMax <span style=color:#f92672>=</span> d;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 平均値を求める
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dataAve <span style=color:#f92672>=</span> (sum <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>20</span>; <span style=color:#75715e>// 平均値計算（精度確保のため10倍値で計算）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 表示のmax,minを決める
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (vRange <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>) { <span style=color:#75715e>// Autoレンジなら（レンジ番号が1かそれ以下）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMin <span style=color:#f92672>=</span> dataMin <span style=color:#f92672>-</span> <span style=color:#ae81ff>20</span>; <span style=color:#75715e>// 表示レンジ下限を-20下に設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMin <span style=color:#f92672>=</span> (rangeMin <span style=color:#f92672>/</span> <span style=color:#ae81ff>10</span>) <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>; <span style=color:#75715e>// 10ステップに丸め
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (rangeMin <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span> rangeMin <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// 但し下限は0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> rangeMax <span style=color:#f92672>=</span> dataMax <span style=color:#f92672>+</span> <span style=color:#ae81ff>20</span>; <span style=color:#75715e>// 表示レンジ上限を+20上に設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMax <span style=color:#f92672>=</span> ((rangeMax <span style=color:#f92672>/</span> <span style=color:#ae81ff>10</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>; <span style=color:#75715e>// 切り上げで10ステップに丸め
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (rangeMax <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1020</span>) {
</span></span><span style=display:flex><span> rangeMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>1023</span>; <span style=color:#75715e>// 但し1020以上なら1023で抑える
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (att10x <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) { <span style=color:#75715e>// アッテネータ有
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMaxDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> (rangeMax <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> lsb50V); <span style=color:#75715e>// 表示範囲はデーターで決める。つまり上限はADCのフルスケールまで
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMinDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> (rangeMin <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> lsb50V); <span style=color:#75715e>// 下限は測定結果によるが、最低でもゼロ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> } <span style=color:#66d9ef>else</span> { <span style=color:#75715e>// アッテネータ無し
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> rangeMaxDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> (rangeMax <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> lsb5V); 
</span></span><span style=display:flex><span> rangeMinDisp <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> (rangeMin <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> lsb5V);
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> } <span style=color:#66d9ef>else</span> { <span style=color:#75715e>// 固定レンジなら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#75715e>// 必要な処理をここに書く（今のところ無し）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// トリガ位置を探す
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>for</span> (trigP <span style=color:#f92672>=</span> ((REC_LENGTH <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>51</span>); trigP <span style=color:#f92672>&lt;</span> ((REC_LENGTH <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span>); trigP<span style=color:#f92672>++</span>) { <span style=color:#75715e>// データー範囲の中央で、中央値を跨いでいるポイントを探す
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (trigD <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>// トリガ方向が0（正トリガ）なら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> ((waveBuff[trigP <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> (dataMax <span style=color:#f92672>+</span> dataMin) <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>&amp;&amp;</span> (waveBuff[trigP] <span style=color:#f92672>&gt;=</span> (dataMax <span style=color:#f92672>+</span> dataMin) <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>)) {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>break</span>; <span style=color:#75715e>// 立ち上がりトリガ検出！
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> } <span style=color:#66d9ef>else</span> { <span style=color:#75715e>// 0でなかったら（負トリガ）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> ((waveBuff[trigP <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>&gt;</span> (dataMax <span style=color:#f92672>+</span> dataMin) <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>&amp;&amp;</span> (waveBuff[trigP] <span style=color:#f92672>&lt;=</span> (dataMax <span style=color:#f92672>+</span> dataMin) <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>)) {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span> } <span style=color:#75715e>// 立下りトリガ検出！
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> trigSync <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (trigP <span style=color:#f92672>&gt;=</span> ((REC_LENGTH <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>50</span>)) { <span style=color:#75715e>// トリガが見つからなかったら中央にしておく
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> trigP <span style=color:#f92672>=</span> (REC_LENGTH <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span> trigSync <span style=color:#f92672>=</span> false; <span style=color:#75715e>// Unsync表示用フラグ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startScreen</span>() { <span style=color:#75715e>// 開始時の画面表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.clearDisplay();
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setTextSize</span>(<span style=color:#ae81ff>2</span>); <span style=color:#75715e>// 文字を2倍角で、
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.setTextColor(WHITE); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>15</span>); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>println</span>(F(<span style=color:#e6db74>&#34;DSO start&#34;</span>)); <span style=color:#75715e>// 開始画面表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>35</span>); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>println</span>(F(<span style=color:#e6db74>&#34; v0.8&#34;</span>));
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>display</span>(); <span style=color:#75715e>// 表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>delay</span>(<span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.clearDisplay();
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setTextSize</span>(<span style=color:#ae81ff>1</span>); <span style=color:#75715e>// 以降は標準文字サイズ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dispHold</span>() { <span style=color:#75715e>// 画面にHoldを表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.fillRect(<span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>8</span>, BLACK); <span style=color:#75715e>// 4文字分黒塗り
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>12</span>);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>print</span>(F(<span style=color:#e6db74>&#34;Hold&#34;</span>)); <span style=color:#75715e>// Hold 表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>display</span>(); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>dispInf</span>() { <span style=color:#75715e>// 各種情報表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>float</span> voltage;
</span></span><span style=display:flex><span> <span style=color:#75715e>// 垂直感度表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 画面の左上に
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>print</span>(vScale); <span style=color:#75715e>// 垂直感度常時
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (scopeP <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>// スコープが当たっていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>27</span>, WHITE); <span style=color:#75715e>// 下側枠線を表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastVLine(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>2</span>, WHITE);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.drawFastVLine(<span style=color:#ae81ff>26</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>2</span>, WHITE);
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 水平感度表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>34</span>, <span style=color:#ae81ff>0</span>); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>print</span>(hScale); <span style=color:#75715e>// 横軸スケール(time/div)表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (scopeP <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) { <span style=color:#75715e>// スコープが当たっていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>33</span>, WHITE); <span style=color:#75715e>// 下側枠線を表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastVLine(<span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>2</span>, WHITE);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.drawFastVLine(<span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>2</span>, WHITE);
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// トリガ極性表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>75</span>, <span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 波形の中央上に
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (trigD <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>print</span>(<span style=color:#66d9ef>char</span>(<span style=color:#ae81ff>0x18</span>)); <span style=color:#75715e>// トリガ極性表示↑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>print</span>(<span style=color:#66d9ef>char</span>(<span style=color:#ae81ff>0x19</span>)); <span style=color:#75715e>// ↓
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (scopeP <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>) { <span style=color:#75715e>// スコープが当たっていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastHLine(<span style=color:#ae81ff>71</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>13</span>, WHITE); <span style=color:#75715e>// 下側枠線を表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawFastVLine(<span style=color:#ae81ff>71</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>2</span>, WHITE);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.drawFastVLine(<span style=color:#ae81ff>83</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>2</span>, WHITE);
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 平均電圧表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (att10x <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) { <span style=color:#75715e>// 10倍アッテネーターが入っていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> voltage <span style=color:#f92672>=</span> dataAve <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> lsb50V <span style=color:#f92672>/</span> <span style=color:#ae81ff>10.0</span>; <span style=color:#75715e>// 50Vレンジの感度係数で電圧計算
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span> voltage <span style=color:#f92672>=</span> dataAve <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> lsb5V <span style=color:#f92672>/</span> <span style=color:#ae81ff>10.0</span>; <span style=color:#75715e>// 5Vレンジの感度係数で電圧計算
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> dtostrf(voltage, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>2</span>, chrBuff); <span style=color:#75715e>// x.xx 形式に変換
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>98</span>, <span style=color:#ae81ff>0</span>); <span style=color:#75715e>// 画面の右上に
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>print</span>(chrBuff); <span style=color:#75715e>// 電圧の平均値を表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#75715e>// display.print(saveTimer); // デバッグ用の表示はここが便利
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 縦軸目盛り表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> voltage <span style=color:#f92672>=</span> rangeMaxDisp <span style=color:#f92672>/</span> <span style=color:#ae81ff>100.0</span>; <span style=color:#75715e>// Max電圧を換算
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (vRange <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> vRange <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>4</span>) { <span style=color:#75715e>// 感度が5V以下もしくはAuto5Vなら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dtostrf(voltage, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>2</span>, chrBuff); <span style=color:#75715e>// \*.\*\* 形式に変換
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> } <span style=color:#66d9ef>else</span> { <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dtostrf(voltage, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>1</span>, chrBuff); <span style=color:#75715e>// \*\*.\* 形式に変換
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>9</span>);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>print</span>(chrBuff); <span style=color:#75715e>// Max値表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> voltage <span style=color:#f92672>=</span> (rangeMaxDisp <span style=color:#f92672>+</span> rangeMinDisp) <span style=color:#f92672>/</span> <span style=color:#ae81ff>200.0</span>; <span style=color:#75715e>// 中央値を計算
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (vRange <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> vRange <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>4</span>) { <span style=color:#75715e>// 感度が5V以下もしくはAuto5Vなら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dtostrf(voltage, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>2</span>, chrBuff); <span style=color:#75715e>// 小数点以下2桁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> } <span style=color:#66d9ef>else</span> { <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dtostrf(voltage, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>1</span>, chrBuff); <span style=color:#75715e>// 小数点以下1桁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>33</span>);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>print</span>(chrBuff); <span style=color:#75715e>// 中心値表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> voltage <span style=color:#f92672>=</span> rangeMinDisp <span style=color:#f92672>/</span> <span style=color:#ae81ff>100.0</span>; <span style=color:#75715e>// Min値を計算
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (vRange <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> vRange <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>4</span>) { <span style=color:#75715e>// 感度が5V以下もしくはAuto5Vなら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> dtostrf(voltage, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>2</span>, chrBuff); <span style=color:#75715e>// 数点以下2桁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span> dtostrf(voltage, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>1</span>, chrBuff); <span style=color:#75715e>// 小数点以下1桁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>57</span>);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>print</span>(chrBuff); <span style=color:#75715e>// Min値表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// トリガ検出ミス表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (trigSync <span style=color:#f92672>==</span> false) { <span style=color:#75715e>// トリガの検出に失敗していたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>setCursor</span>(<span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>55</span>); <span style=color:#75715e>// 画面の中央下に
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.<span style=color:#a6e22e>print</span>(F(<span style=color:#e6db74>&#34;Unsync&#34;</span>)); <span style=color:#75715e>// Unsync を表示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>plotData</span>() { <span style=color:#75715e>// 配列の値に基づきデーターをプロット
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>long</span> y1, y2;
</span></span><span style=display:flex><span> <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>98</span>; x<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span> y1 <span style=color:#f92672>=</span> <span style=color:#a6e22e>map</span>(waveBuff[x <span style=color:#f92672>+</span> trigP <span style=color:#f92672>-</span> <span style=color:#ae81ff>50</span>], rangeMin, rangeMax, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>9</span>); <span style=color:#75715e>// プロット座標へ変換
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> y1 <span style=color:#f92672>=</span> <span style=color:#a6e22e>constrain</span>(y1, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>63</span>); <span style=color:#75715e>// はみ出し部は潰す
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> y2 <span style=color:#f92672>=</span> <span style=color:#a6e22e>map</span>(waveBuff[x <span style=color:#f92672>+</span> trigP <span style=color:#f92672>-</span> <span style=color:#ae81ff>49</span>], rangeMin, rangeMax, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>9</span>); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> y2 <span style=color:#f92672>=</span> <span style=color:#a6e22e>constrain</span>(y2, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>63</span>); <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>display</span>.drawLine(x <span style=color:#f92672>+</span> <span style=color:#ae81ff>27</span>, y1, x <span style=color:#f92672>+</span> <span style=color:#ae81ff>28</span>, y2, WHITE); <span style=color:#75715e>// 点間を線で結ぶ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>saveEEPROM</span>() { <span style=color:#75715e>// ボタン操作が終わって少し待ってから、EEPROMに設定値を保存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (paraChanged <span style=color:#f92672>==</span> true) { <span style=color:#75715e>// もしパラメータ変更があった場合は
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> saveTimer <span style=color:#f92672>=</span> saveTimer <span style=color:#f92672>-</span> timeExec; <span style=color:#75715e>// カウントダウンタイマー更新
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (saveTimer <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>// タイムアップしたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> paraChanged <span style=color:#f92672>=</span> false; <span style=color:#75715e>// パラメーター変更フラグクリア
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>EEPROM</span>.<span style=color:#a6e22e>write</span>(<span style=color:#ae81ff>0</span>, vRange); <span style=color:#75715e>// 現在の設定状態を保存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>EEPROM</span>.<span style=color:#a6e22e>write</span>(<span style=color:#ae81ff>1</span>, hRange);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>EEPROM</span>.<span style=color:#a6e22e>write</span>(<span style=color:#ae81ff>2</span>, trigD);
</span></span><span style=display:flex><span> <span style=color:#a6e22e>EEPROM</span>.<span style=color:#a6e22e>write</span>(<span style=color:#ae81ff>3</span>, scopeP);
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loadEEPROM</span>() { <span style=color:#75715e>// EEPROMに保存した設定値を読み出す
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>int</span> x;
</span></span><span style=display:flex><span> x <span style=color:#f92672>=</span> <span style=color:#a6e22e>EEPROM</span>.<span style=color:#a6e22e>read</span>(<span style=color:#ae81ff>0</span>); <span style=color:#75715e>// vRange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> ((x <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>||</span> (x <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>9</span>)) { <span style=color:#75715e>// 0-9の範囲外だったら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> x <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>; <span style=color:#75715e>// デフォルト値設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> vRange <span style=color:#f92672>=</span> x;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> x <span style=color:#f92672>=</span> <span style=color:#a6e22e>EEPROM</span>.<span style=color:#a6e22e>read</span>(<span style=color:#ae81ff>1</span>); <span style=color:#75715e>// hRange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> ((x <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>||</span> (x <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>7</span>)) { <span style=color:#75715e>// 0-9の範囲外だったら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> x <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>; <span style=color:#75715e>// デフォルト値設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> hRange <span style=color:#f92672>=</span> x;
</span></span><span style=display:flex><span> x <span style=color:#f92672>=</span> <span style=color:#a6e22e>EEPROM</span>.<span style=color:#a6e22e>read</span>(<span style=color:#ae81ff>2</span>); <span style=color:#75715e>// trigD
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> ((x <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>||</span> (x <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>)) { <span style=color:#75715e>// 0-9の範囲外だったら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// デフォルト値設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> trigD <span style=color:#f92672>=</span> x;
</span></span><span style=display:flex><span> x <span style=color:#f92672>=</span> <span style=color:#a6e22e>EEPROM</span>.<span style=color:#a6e22e>read</span>(<span style=color:#ae81ff>3</span>); <span style=color:#75715e>// scopeP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> ((x <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>||</span> (x <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2</span>)) { <span style=color:#75715e>// 0-9の範囲外だったら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// デフォルト値設定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> scopeP <span style=color:#f92672>=</span> x;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pin2IRQ</span>() { <span style=color:#75715e>// Pin2(int0)割込みの処理
</span></span></span><span style=display:flex><span><span style=color:#75715e>//　操作ボタン（タクトスイッチ）のpin8,9,10,11はダイオードで束ねてPin2に
</span></span></span><span style=display:flex><span><span style=color:#75715e>//　接続されている。つまりいずれかのボタンが押されればここのルーチンが発動。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>int</span> x; <span style=color:#75715e>// ポート情報保持変数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> x <span style=color:#f92672>=</span> PINB; <span style=color:#75715e>// ポートBの情報を読む
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> ( (x <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x07</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0x07</span>) { <span style=color:#75715e>// 下位3ビットが全部Highで無ければ（どれかが押されていたら）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> saveTimer <span style=color:#f92672>=</span> <span style=color:#ae81ff>5000</span>; <span style=color:#75715e>// EEPROM保存タイマーセット(ms単位で設定）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> paraChanged <span style=color:#f92672>=</span> true; <span style=color:#75715e>// パラメータ変化有りフラグON
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> ((x <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x01</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span> scopeP<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (scopeP <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span> scopeP <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> ((x <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x02</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>// UPボタンが押されていて、
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (scopeP <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>// 垂直レンジにスコープが当たっていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> vRange<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (vRange <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>9</span>) {
</span></span><span style=display:flex><span> vRange <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (scopeP <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) { <span style=color:#75715e>// 水平レンジにスコープが当たっていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> hRange<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (hRange <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>7</span>) {
</span></span><span style=display:flex><span> hRange <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (scopeP <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>) { <span style=color:#75715e>// トリガ方向ボタンにスコープが当たっていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> trigD <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// プラストリガ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> ((x <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x04</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>// DOWNボタンが押されていて、
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>if</span> (scopeP <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>// 垂直レンジにスコープが当たっていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> vRange<span style=color:#f92672>--</span>;
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (vRange <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span> vRange <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (scopeP <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) { <span style=color:#75715e>// 水平レンジにスコープが当たっていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> hRange<span style=color:#f92672>--</span>;
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (hRange <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span> hRange <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> (scopeP <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>) { <span style=color:#75715e>// トリガ方向ボタンにスコープが当たっていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> trigD <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// マイナストリガ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> ((x <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x08</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>// HOLDボタンが押されていたら
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> hold <span style=color:#f92672>=</span> <span style=color:#f92672>!</span> hold; <span style=color:#75715e>// フラグ反転
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Pero finalmente to no use un arduino totalmente, yo use solo el chip <strong>Atmega328P</strong>, pero las conecciones fueron las equivalentes, solo le tuve que ñadir el cristal oscilante</p></main></body></html>