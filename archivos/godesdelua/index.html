<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Go desde Lua</title><link rel=stylesheet href=/css/style.css type=text/css media=all></head><body><main class=content><h1>Go desde Lua</h1><div class=contenidos><a href=/entradas/>Entradas</a>
<a href=/archivos/>Archivos</a>
<a href=/wallpapers/>Wallpaper</a>
<a href=/problemas>Problemas</a></div><h2 id=llamando-codigo-de-go-desde-lua>Llamando codigo de Go desde Lua</h2><p>Primero hay que tener un codigo/funciones de go como las siguiente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>+</span><span style=color:#a6e22e>y</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>luego hay que importar la libreria necesaria para convertirlo a codigo de C y tambien indicar que dicha funcion va a ser exportada</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;C&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//export Add
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>+</span><span style=color:#a6e22e>y</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Tambien hay que agregar el paquete y una funcion main vacia, ademas de indicar que la funcion es publica convirtiendo la primera letra a mayuscula</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;C&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//export Add
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>+</span><span style=color:#a6e22e>y</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {}
</span></span></code></pre></div><p>Compilamos el archivo con el siguiente comando</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go build -o awesome.so -buildmode<span style=color:#f92672>=</span>c-shared awesome.go
</span></span></code></pre></div><p>Esto nos generara un archivo llamado <strong>awesome.so</strong>
Luego en Lua se hace lo siguiente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> ffi <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;ffi&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> awesome <span style=color:#f92672>=</span> ffi.load(<span style=color:#e6db74>&#34;./awesome.so&#34;</span>)
</span></span></code></pre></div><p>Y finalmente hay que a√±adir las definiciones, el siguiente ejemplo crea una definicion en un .h para indicar su equivalencia en C</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> ffi <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;ffi&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> awesome <span style=color:#f92672>=</span> ffi.load(<span style=color:#e6db74>&#34;./awesome.so&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ffi.cdef(<span style=color:#e6db74>[[
</span></span></span><span style=display:flex><span><span style=color:#e6db74>typedef long long GoInt64;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>typedef unsigned long long GoUint64;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>typedef GoInt64 GoInt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>typedef GoUint64 GoUint;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>typedef double GoFloat64;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>typedef struct { const char *p; GoInt n; } GoString;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>typedef struct { void *data; GoInt len; GoInt cap; } GoSlice;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>extern GoInt Add(GoInt p0, GoInt p1);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>extern GoFloat64 Cosine(GoFloat64 p0);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>extern void Sort(GoSlice p0);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>extern GoInt Log(GoString p0);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>]]</span>);
</span></span></code></pre></div><p>En nuesttro caso quedaria como:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> ffi <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#34;ffi&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> awesome <span style=color:#f92672>=</span> ffi.load(<span style=color:#e6db74>&#34;./awesome.so&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ffi.cdef(<span style=color:#e6db74>[[
</span></span></span><span style=display:flex><span><span style=color:#e6db74>typedef long long GoInt64;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>typedef GoInt64 GoInt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>extern GoInt Add(GoInt p0, GoInt p1);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>]]</span>);
</span></span></code></pre></div><p>Y se podria ejecutar lo siguiente sin ningun problema:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>awesome.Add(<span style=color:#ae81ff>1</span>,<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>) <span style=color:#75715e>--2</span>
</span></span></code></pre></div></main></body></html>